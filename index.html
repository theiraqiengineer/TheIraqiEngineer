<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Iraqi Engineer ‚Äì Location Confirmation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Apercu:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #10162F;
      --secondary-color: #3A10E5;
      --accent-color: #FFF0E5;
      --text-color: #10162F;
      --light-gray: #F8F9FA;
      --border-color: #DFE1E5;
      --success-color: #37C77F;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Apercu', 'Roboto', sans-serif;
      background: white;
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--light-gray);
    }

    .auth-box {
      background: white;
      padding: 2.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      width: 100%;
      max-width: 440px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-color);
      font-size: 0.95rem;
    }

    input, select {
      width: 100%;
      padding: 0.875rem;
      border: 2px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      transition: all 0.2s;
      background: white;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(58, 16, 229, 0.1);
    }

    button {
      background-color: var(--secondary-color);
      color: white;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    button:hover {
      background-color: #2E0CB7;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .tabs {
      display: flex;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border-color);
    }

    .tab {
      padding: 1rem 2rem;
      cursor: pointer;
      font-weight: 500;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .tab.active {
      color: var(--secondary-color);
      border-bottom: 2px solid var(--secondary-color);
    }

    .hidden {
      display: none;
    }

    .profile-section {
      background: white;
      padding: 2.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-top: 2rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--primary-color);
    }

    .location-section {
      margin-top: 2rem;
      background: white;
      padding: 2.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #map {
      height: 300px;
      width: 100%;
      border-radius: 8px;
      margin-top: 1rem;
      border: 2px solid var(--border-color);
    }

    .error-message {
      color: #dc2626;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }

    .success-message {
      background: var(--accent-color);
      color: var(--primary-color);
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
    }

    #result {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--light-gray);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="auth-container" id="authContainer">
    <div class="auth-box">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('signin')">Sign In</div>
        <div class="tab" onclick="switchTab('signup')">Sign Up</div>
      </div>

      <div id="signinForm">
        <div class="form-group">
          <label for="signinEmail">Email</label>
          <input type="email" id="signinEmail" required>
        </div>
        <div class="form-group">
          <label for="signinPassword">Password</label>
          <input type="password" id="signinPassword" required>
        </div>
        <button onclick="signIn()">Sign In</button>
      </div>

      <div id="signupForm" class="hidden">
        <div class="form-group">
          <label for="signupEmail">Email</label>
          <input type="email" id="signupEmail" required>
        </div>
        <div class="form-group">
          <label for="signupPassword">Password</label>
          <input type="password" id="signupPassword" required>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <input type="password" id="confirmPassword" required>
        </div>
        <button onclick="signUp()">Sign Up</button>
      </div>
    </div>
  </div>

  <div class="container hidden" id="mainContainer">
    <div class="profile-section">
      <h2>Profile Information</h2>
      <div class="form-group">
        <label for="country">Country</label>
        <select id="country" required>
          <option value="">Select Country</option>
          <!-- Add more countries as needed -->
        </select>
      </div>
      <div class="form-group">
        <label for="birthdate">Birth Date</label>
        <input type="date" id="birthdate" required>
      </div>
      <div class="form-group">
        <label for="englishLevel">English Language Level</label>
        <select id="englishLevel" required>
          <option value="">Select Level</option>
          <option value="beginner">Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced</option>
          <option value="native">Native</option>
        </select>
      </div>
      <div class="form-group">
        <label for="studyLevel">Study Level</label>
        <select id="studyLevel" required>
          <option value="">Select Level</option>
          <option value="high_school">High School</option>
          <option value="bachelors">Bachelor's Degree</option>
          <option value="masters">Master's Degree</option>
          <option value="phd">PhD</option>
        </select>
      </div>
      <button onclick="saveProfile()">Save Profile</button>
    </div>

    <div class="location-section">
      <h2>üìç Confirm Your Location</h2>
      <button onclick="sendLocation()">Send Location</button>
      <div id="result"></div>
      <div id="map"></div>
    </div>
  </div>

  <script>
    let userLat, userLon;
    let currentUser = null;
    const API_URL = 'https://backend-lcmx.onrender.com'; // Make sure this matches your deployed backend URL

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
      
      document.getElementById('signinForm').classList.toggle('hidden', tab !== 'signin');
      document.getElementById('signupForm').classList.toggle('hidden', tab !== 'signup');
    }

    // Add error display function
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      // Remove any existing error messages
      const existingError = document.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }
      
      // Add the error message after the sign in button
      const signInButton = document.querySelector('#signinForm button');
      signInButton.parentNode.insertBefore(errorDiv, signInButton.nextSibling);
    }

    function clearError() {
      const errorDiv = document.querySelector('.error-message');
      if (errorDiv) {
        errorDiv.remove();
      }
    }

    async function signIn() {
      clearError();
      const email = document.getElementById('signinEmail').value;
      const password = document.getElementById('signinPassword').value;

      if (!email || !password) {
        showError('Please enter both email and password');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/auth/signin`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'Origin': window.location.origin
          },
          credentials: 'include',
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        
        if (response.ok) {
          currentUser = data;
          localStorage.setItem('token', data.token);
          showMainContainer();
        } else {
          console.error('Login failed:', data);
          showError(data.message || 'Invalid credentials. Please check your email and password.');
        }
      } catch (error) {
        console.error('Sign in error:', error);
        showError('Unable to connect to the server. Please try again later.');
      }
    }

    async function signUp() {
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/auth/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (response.ok) {
          currentUser = await response.json();
          showMainContainer();
        } else {
          const error = await response.json();
          alert(error.message || 'Sign up failed');
        }
      } catch (error) {
        console.error('Sign up error:', error);
        alert('An error occurred during sign up');
      }
    }

    function showMainContainer() {
      document.getElementById('authContainer').classList.add('hidden');
      document.getElementById('mainContainer').classList.remove('hidden');
    }

    async function saveProfile() {
      const profileData = {
        country: document.getElementById('country').value,
        birthdate: document.getElementById('birthdate').value,
        englishLevel: document.getElementById('englishLevel').value,
        studyLevel: document.getElementById('studyLevel').value
      };

      try {
        const response = await fetch(`${API_URL}/api/profile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.token}`
          },
          body: JSON.stringify(profileData)
        });

        if (response.ok) {
          alert('Profile saved successfully');
        } else {
          const error = await response.json();
          alert(error.message || 'Failed to save profile');
        }
      } catch (error) {
        console.error('Profile save error:', error);
        alert('An error occurred while saving profile');
      }
    }

    function sendLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          userLat = position.coords.latitude;
          userLon = position.coords.longitude;

          fetch(`${API_URL}/api/verify-location`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${currentUser.token}`
            },
            body: JSON.stringify({ latitude: userLat, longitude: userLon })
          })
          .then(res => res.json())
          .then(data => {
            document.getElementById('result').innerHTML = `
              <p><strong>‚úÖ Message:</strong> ${data.message}</p>
              <p><strong>üåç Your Location:</strong> ${data.your_location}</p>
            `;
            initMap();
          });
        }, () => {
          alert('Location permission denied');
        });
      } else {
        alert('Geolocation not supported');
      }
    }

    function initMap() {
      const userLocation = { lat: userLat, lng: userLon };
      const targetLocation = { lat: 33.31525, lng: 44.36608 };

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 4,
        center: userLocation,
      });

      new google.maps.Marker({
        position: userLocation,
        map,
        label: "You",
        title: "Your Location",
      });

      new google.maps.Marker({
        position: targetLocation,
        map,
        label: "üìç",
        title: "Baghdad (Target Location)",
      });

      new google.maps.Circle({
        strokeColor: "#007bff",
        strokeOpacity: 0.6,
        strokeWeight: 2,
        fillColor: "#007bff",
        fillOpacity: 0.1,
        map,
        center: targetLocation,
        radius: 100,
      });
    }

    // Add country list population
    const countries = [
      "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
      "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina",
      "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic",
      "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti",
      "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji",
      "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana",
      "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan",
      "Kazakhstan", "Kenya", "Kiribati", "Korea, North", "Korea, South", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho",
      "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands",
      "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia",
      "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau",
      "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda",
      "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia",
      "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa",
      "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand",
      "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine",
      "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
      "Yemen", "Zambia", "Zimbabwe"
    ];

    // Populate country select
    window.onload = function() {
      const countrySelect = document.getElementById('country');
      countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countrySelect.appendChild(option);
      });
    };
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfaI-Vkvzl5w-Gw7yCNFvU3K952i7kQ20&callback=initMap">
  </script>
</body>
</html>

